<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heating Degree Days Calculator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        input[type="date"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: #f39c12;
            background: rgba(255, 255, 255, 0.15);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            text-align: center;
            display: none;
        }

        .result.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-value {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .result-label {
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .result-details {
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .data-source {
            margin-top: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 12px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .error.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .loading {
            margin-top: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #f39c12;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .data-note {
            margin-top: 25px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .data-note a {
            color: #3498db;
            text-decoration: none;
        }

        .data-note a:hover {
            text-decoration: underline;
        }

        .cached-years {
            margin-top: 10px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå°Ô∏è Heating Degree Days</h1>
        <p class="subtitle">New Milford, CT (65¬∞F Base)</p>

        <div class="form-group">
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" value="2025-01-22">
        </div>

        <div class="form-group">
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" value="2025-03-04">
        </div>

        <button id="calcBtn" onclick="calculateHDD()">Calculate</button>

        <div class="loading" id="loading">
            <span class="spinner"></span>
            <span id="loadingText">Fetching data...</span>
        </div>

        <div class="error" id="error"></div>

        <div class="result" id="result">
            <div class="result-value" id="totalHDD">0</div>
            <div class="result-label">Total Heating Degree Days</div>
            <div class="result-details" id="resultDetails"></div>
            <div class="data-source" id="dataSource"></div>
        </div>

        <div class="data-note">
            Data source: <a href="https://www.newmilfordctweather.com/wxdegreedetail.php?year=2025" target="_blank">New Milford CT Weather</a><br>
            Supports years 2013-present (fetches additional years as needed)
            <div class="cached-years" id="cachedYears">Cached: 2025</div>
        </div>
    </div>

    <script>
        // Heating Degree Days data cache - pre-loaded with 2025 data
        const hddCache = {
            2025: {
                1: [24.7, 29.9, 34.3, 37.2, 37.0, 41.2, 42.2, 42.6, 40.2, 34.8, 35.9, 34.1, 34.3, 39.8, 42.3, 42.1, 39.1, 32.9, 34.4, 48.1, 55.8, 57.9, 50.2, 47.9, 46.8, 40.0, 38.1, 35.3, 32.1, 40.5, 33.3],
                2: [38.8, 45.5, 33.1, 31.5, 41.4, 37.4, 34.1, 38.3, 35.6, 39.2, 41.9, 34.1, 30.3, 36.5, 39.4, 32.7, 39.8, 46.8, 46.0, 44.9, 42.1, 41.4, 32.1, 29.2, 27.2, 25.4, 27.2, 27.9],
                3: [27.2, 43.0, 41.1, 31.8, 22.3, 21.6, 29.0, 31.6, 30.7, 23.2, 20.7, 22.3, 23.0, 21.0, 21.6, 12.8, 17.1, 24.1, 19.0, 18.4, 24.7, 23.1, 30.5, 26.0, 21.2, 27.5, 29.2, 20.5, 14.1, 23.3, 12.2],
                4: [22.5, 26.1, 14.3, 6.4, 19.9, 19.0, 24.9, 28.2, 29.9, 26.3, 23.3, 27.8, 21.4, 14.7, 11.7, 21.6, 18.8, 14.5, 0.7, 8.2, 16.2, 5.4, 5.9, 4.4, 0.9, 4.0, 16.3, 9.3, 3.6, 3.2],
                5: [7.9, 2.9, 0.0, 1.3, 5.3, 4.7, 4.9, 4.4, 10.8, 10.0, 9.3, 7.7, 3.4, 4.2, 0.1, 0.0, 0.0, 4.0, 8.7, 11.6, 14.3, 18.5, 16.4, 13.5, 11.1, 6.3, 4.8, 4.9, 5.8, 2.3, 7.4],
                6: [11.2, 7.4, 3.6, 0.0, 0.0, 0.0, 0.0, 0.0, 2.9, 0.4, 0.0, 0.0, 0.0, 4.0, 2.0, 1.8, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                7: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                8: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.4, 3.3, 3.1, 0.7, 0.0, 0.0, 0.0, 0.0, 1.9, 3.1, 0.4, 4.3, 2.3],
                9: [1.9, 0.9, 1.6, 0.0, 0.0, 0.0, 2.1, 7.6, 6.5, 2.1, 2.5, 1.7, 0.0, 0.0, 0.0, 0.6, 1.5, 0.0, 0.0, 6.2, 8.5, 6.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.0],
                10: [7.1, 12.9, 10.6, 0.7, 1.0, 0.1, 0.0, 4.4, 16.3, 19.9, 9.8, 9.1, 12.4, 10.4, 10.0, 17.7, 15.9, 15.4, 9.3, 6.6, 11.9, 10.8, 15.7, 18.3, 20.3, 19.9, 23.8, 21.7, 18.1, 14.1, 13.5],
                11: [17.6, 23.6, 20.2, 19.9, 19.6, 21.4, 22.8, 15.0, 13.5, 19.1, 31.2, 25.6, 23.5, 27.1, 28.0, 23.5, 27.2, 28.3, 30.3, 31.7, 27.8, 25.3, 32.1, 26.8, 24.7, 13.6, 25.4, 29.0, 32.1, 29.5],
                12: [32.1, 34.7, 34.6, 36.4, 44.7, 34.8, 35.4, 42.9, 45.8, 32.9, 36.1, 39.7, 38.6, 40.1, 46.1, 40.4, 34.4, 32.3, 22.3, 34.7, 32.6, 37.3, 32.8, 30.8, 34.4, 45.3, 42.3, 42.2, 31.1, 39.2, 40.6]
            }
        };

        function updateCachedYearsDisplay() {
            const years = Object.keys(hddCache).sort();
            document.getElementById('cachedYears').textContent = 'Cached: ' + years.join(', ');
        }

        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return { year, month, day };
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getYearsInRange(startYear, endYear) {
            const years = [];
            for (let y = startYear; y <= endYear; y++) {
                years.push(y);
            }
            return years;
        }

        function getMissingYears(startYear, endYear) {
            const needed = getYearsInRange(startYear, endYear);
            return needed.filter(y => !hddCache[y]);
        }

        async function fetchYearData(year) {
            const url = `https://www.newmilfordctweather.com/wxdegreedetail.php?year=${year}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const html = await response.text();
                return parseHDDFromHTML(html, year);
            } catch (error) {
                console.error(`Error fetching year ${year}:`, error);
                throw error;
            }
        }

        function parseHDDFromHTML(html, year) {
            const yearData = {};
            
            // Create a temporary DOM element to parse HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find the main data table - it has Heating Degree Days header
            const tables = doc.querySelectorAll('table');
            let dataTable = null;
            
            for (const table of tables) {
                const text = table.textContent;
                if (text.includes('Heating Degree Days') && text.includes('Cooling Degree Days')) {
                    dataTable = table;
                    break;
                }
            }
            
            if (!dataTable) {
                throw new Error('Could not find data table');
            }
            
            const rows = dataTable.querySelectorAll('tr');
            
            // Find the data rows (days 1-31)
            for (const row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 13) {
                    const dayText = cells[0].textContent.trim();
                    const day = parseInt(dayText);
                    
                    if (day >= 1 && day <= 31) {
                        // Columns 1-12 are Jan-Dec heating degree days
                        for (let month = 1; month <= 12; month++) {
                            const cellText = cells[month].textContent.trim();
                            const value = parseFloat(cellText);
                            
                            if (!yearData[month]) {
                                yearData[month] = [];
                            }
                            
                            if (!isNaN(value)) {
                                yearData[month][day - 1] = value;
                            }
                        }
                    }
                }
            }
            
            return yearData;
        }

        async function ensureDataLoaded(startYear, endYear) {
            const missing = getMissingYears(startYear, endYear);
            
            if (missing.length === 0) {
                return true;
            }
            
            const loadingEl = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            loadingEl.classList.add('show');
            
            for (const year of missing) {
                loadingText.textContent = `Fetching ${year} data...`;
                try {
                    const data = await fetchYearData(year);
                    hddCache[year] = data;
                } catch (error) {
                    loadingEl.classList.remove('show');
                    throw new Error(`Failed to fetch data for ${year}: ${error.message}`);
                }
            }
            
            loadingEl.classList.remove('show');
            updateCachedYearsDisplay();
            return true;
        }

        function computeHDD(startDateStr, endDateStr) {
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            
            let totalHDD = 0;
            let dayCount = 0;
            let missingDays = 0;
            let currentDate = new Date(start);

            while (currentDate <= end) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const day = currentDate.getDate();
                
                if (hddCache[year] && hddCache[year][month] && hddCache[year][month][day - 1] !== undefined) {
                    totalHDD += hddCache[year][month][day - 1];
                    dayCount++;
                } else {
                    missingDays++;
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return { totalHDD, dayCount, missingDays };
        }

        async function calculateHDD() {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const errorEl = document.getElementById('error');
            const resultEl = document.getElementById('result');
            const calcBtn = document.getElementById('calcBtn');

            errorEl.classList.remove('show');
            resultEl.classList.remove('show');

            if (!startDateStr || !endDateStr) {
                errorEl.textContent = 'Please select both start and end dates.';
                errorEl.classList.add('show');
                return;
            }

            const startDate = parseDate(startDateStr);
            const endDate = parseDate(endDateStr);

            const start = new Date(startDateStr);
            const end = new Date(endDateStr);

            if (start > end) {
                errorEl.textContent = 'Start date must be before or equal to end date.';
                errorEl.classList.add('show');
                return;
            }

            // Check year range (data available from 2013)
            if (startDate.year < 2013 || endDate.year < 2013) {
                errorEl.textContent = 'Data is only available from 2013 onwards.';
                errorEl.classList.add('show');
                return;
            }

            calcBtn.disabled = true;

            try {
                // Fetch any missing years
                await ensureDataLoaded(startDate.year, endDate.year);
                
                // Compute the HDD
                const { totalHDD, dayCount, missingDays } = computeHDD(startDateStr, endDateStr);

                document.getElementById('totalHDD').textContent = totalHDD.toFixed(1);
                
                let detailText = `${dayCount} days from ${formatDate(startDateStr)} to ${formatDate(endDateStr)}`;
                if (missingDays > 0) {
                    detailText += ` (${missingDays} days with no data)`;
                }
                document.getElementById('resultDetails').textContent = detailText;
                
                // Show which years were used
                const yearsUsed = getYearsInRange(startDate.year, endDate.year);
                document.getElementById('dataSource').textContent = `Data from: ${yearsUsed.join(', ')}`;
                
                resultEl.classList.add('show');
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.add('show');
            } finally {
                calcBtn.disabled = false;
            }
        }

        // Set default dates
        document.getElementById('startDate').value = '2025-01-22';
        document.getElementById('endDate').value = '2025-03-04';
        updateCachedYearsDisplay();
    </script>
</body>
</html>
